<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Глава 17: Cart | iOS Book</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: { extend: { colors: { primary: '#007AFF' } } }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
</head>
<body class="bg-white dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100">
    <button id="menuBtn" class="lg:hidden fixed top-4 left-4 z-50 p-3 bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-xl shadow-lg">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </button>

    <div class="flex min-h-screen">
        <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-zinc-50 dark:bg-zinc-900 border-r border-zinc-200 dark:border-zinc-800 flex flex-col z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
            <div class="p-5 border-b border-zinc-200 dark:border-zinc-800">
                <a href="../index.html" class="flex items-center gap-3 text-lg font-semibold hover:text-primary transition-colors">
                    <div class="w-9 h-9 bg-primary rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    iOS Book
                </a>
            </div>
            <nav class="flex-1 overflow-y-auto p-4">
                <div class="space-y-6">
                    <div>
                        <h3 class="px-3 mb-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">Введение</h3>
                        <a href="00-introduction.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">Введение</a>
                    </div>
                    <div>
                        <h3 class="px-3 mb-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">Основы Swift</h3>
                        <div class="space-y-1">
                            <a href="01-xcode.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">1. Xcode</a>
                            <a href="02-swift-basics.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">2. Основы Swift</a>
                            <a href="03-control-flow.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">3. Control Flow</a>
                            <a href="04-functions.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">4. Функции</a>
                            <a href="05-oop.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">5. ООП</a>
                            <a href="06-protocols.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">6. Протоколы</a>
                            <a href="07-optionals.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">7. Optionals</a>
                            <a href="08-memory.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">8. Память</a>
                            <a href="09-generics.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">9. Generics</a>
                            <a href="10-concurrency.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">10. Concurrency</a>
                        </div>
                    </div>
                    <div>
                        <h3 class="px-3 mb-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">UIKit</h3>
                        <div class="space-y-1">
                            <a href="11-uikit-basics.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">11. UIKit</a>
                            <a href="12-programmatic-ui.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">12. Programmatic UI</a>
                        </div>
                    </div>
                    <div>
                        <h3 class="px-3 mb-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">Архитектура</h3>
                        <div class="space-y-1">
                            <a href="13-viper.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">13. VIPER</a>
                            <a href="14-project-setup.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">14. Project Setup</a>
                        </div>
                    </div>
                    <div>
                        <h3 class="px-3 mb-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">Практика</h3>
                        <div class="space-y-1">
                            <a href="15-authentication.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">15. Auth</a>
                            <a href="16-products.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">16. Products</a>
                            <a href="17-cart.html" class="block px-3 py-2 text-sm text-white bg-primary rounded-lg">17. Cart</a>
                            <a href="18-favorites.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">18. Favorites</a>
                            <a href="19-orders.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">19. Orders</a>
                            <a href="20-profile.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">20. Profile</a>
                        </div>
                    </div>
                    <div>
                        <h3 class="px-3 mb-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">Дополнительно</h3>
                        <a href="21-reusable-views.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">21. Reusable Views</a>
                    </div>
                </div>
            </nav>
        </aside>

        <div id="overlay" class="fixed inset-0 bg-black/50 z-30 lg:hidden hidden" onclick="closeSidebar()"></div>

        <main class="flex-1 lg:ml-72">
            <article class="max-w-3xl mx-auto px-6 sm:px-8 lg:px-12 py-12 lg:py-16">
                <header class="mb-12 pb-8 border-b border-zinc-200 dark:border-zinc-800">
                    <span class="text-sm font-semibold uppercase tracking-wider text-primary">Глава 17</span>
                    <h1 class="text-3xl sm:text-4xl font-bold mt-2 mb-4">Cart</h1>
                    <p class="text-lg text-zinc-600 dark:text-zinc-400">Корзина покупок, Firestore</p>
                </header>

                <div class="prose prose-zinc dark:prose-invert max-w-none">
                    <!-- Введение -->
                    <p class="text-lg leading-relaxed mb-8">
                        Корзина — ключевой компонент интернет-магазина. В этой главе мы реализуем
                        полноценный модуль корзины с добавлением товаров, изменением количества,
                        удалением и расчётом итоговой стоимости.
                    </p>

                    <!-- CartItem Model -->
                    <h2 class="text-2xl font-bold mt-12 mb-6">Модель CartItem</h2>

                    <div class="bg-zinc-900 rounded-xl p-6 mb-8 font-mono text-sm overflow-x-auto">
<pre class="text-zinc-300">
<span class="text-zinc-500">// CartItem.swift</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">Foundation</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">FirebaseFirestore</span>

<span class="text-pink-400">struct</span> <span class="text-cyan-400">CartItem</span>: <span class="text-cyan-400">Identifiable</span>, <span class="text-cyan-400">Codable</span> {
    <span class="text-pink-400">@DocumentID var</span> id: <span class="text-cyan-400">String</span>?
    <span class="text-pink-400">let</span> productId: <span class="text-cyan-400">String</span>
    <span class="text-pink-400">let</span> productName: <span class="text-cyan-400">String</span>
    <span class="text-pink-400">let</span> productImageURL: <span class="text-cyan-400">String</span>
    <span class="text-pink-400">let</span> price: <span class="text-cyan-400">Double</span>
    <span class="text-pink-400">var</span> quantity: <span class="text-cyan-400">Int</span>
    <span class="text-pink-400">let</span> addedAt: <span class="text-cyan-400">Date</span>

    <span class="text-pink-400">var</span> totalPrice: <span class="text-cyan-400">Double</span> {
        price * <span class="text-cyan-400">Double</span>(quantity)
    }

    <span class="text-pink-400">var</span> formattedPrice: <span class="text-cyan-400">String</span> {
        <span class="text-cyan-400">String</span>(format: <span class="text-green-400">"%.0f ₸"</span>, price)
    }

    <span class="text-pink-400">var</span> formattedTotalPrice: <span class="text-cyan-400">String</span> {
        <span class="text-cyan-400">String</span>(format: <span class="text-green-400">"%.0f ₸"</span>, totalPrice)
    }
}
</pre>
                    </div>

                    <!-- CartService -->
                    <h2 class="text-2xl font-bold mt-12 mb-6">CartService</h2>

                    <p class="mb-4">
                        Сервис для работы с корзиной в Firestore с поддержкой реального времени:
                    </p>

                    <div class="bg-zinc-900 rounded-xl p-6 mb-8 font-mono text-sm overflow-x-auto">
<pre class="text-zinc-300">
<span class="text-zinc-500">// CartService.swift</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">Foundation</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">FirebaseFirestore</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">FirebaseAuth</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">Combine</span>

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">CartServiceProtocol</span> {
    <span class="text-pink-400">var</span> cartItemsPublisher: <span class="text-cyan-400">AnyPublisher</span>&lt;[<span class="text-cyan-400">CartItem</span>], <span class="text-cyan-400">Never</span>&gt; { <span class="text-pink-400">get</span> }
    <span class="text-pink-400">var</span> cartItems: [<span class="text-cyan-400">CartItem</span>] { <span class="text-pink-400">get</span> }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">addToCart</span>(<span class="text-purple-400">_</span> product: <span class="text-cyan-400">Product</span>) <span class="text-pink-400">async throws</span>
    <span class="text-pink-400">func</span> <span class="text-yellow-300">updateQuantity</span>(itemId: <span class="text-cyan-400">String</span>, quantity: <span class="text-cyan-400">Int</span>) <span class="text-pink-400">async throws</span>
    <span class="text-pink-400">func</span> <span class="text-yellow-300">removeFromCart</span>(itemId: <span class="text-cyan-400">String</span>) <span class="text-pink-400">async throws</span>
    <span class="text-pink-400">func</span> <span class="text-yellow-300">clearCart</span>() <span class="text-pink-400">async throws</span>
    <span class="text-pink-400">func</span> <span class="text-yellow-300">startListening</span>()
    <span class="text-pink-400">func</span> <span class="text-yellow-300">stopListening</span>()
}

<span class="text-pink-400">final class</span> <span class="text-cyan-400">CartService</span>: <span class="text-cyan-400">CartServiceProtocol</span> {

    <span class="text-pink-400">static let</span> shared = <span class="text-cyan-400">CartService</span>()

    <span class="text-pink-400">private let</span> db = <span class="text-cyan-400">Firestore</span>.<span class="text-yellow-300">firestore</span>()
    <span class="text-pink-400">private var</span> listener: <span class="text-cyan-400">ListenerRegistration</span>?

    <span class="text-pink-400">private let</span> cartItemsSubject = <span class="text-cyan-400">CurrentValueSubject</span>&lt;[<span class="text-cyan-400">CartItem</span>], <span class="text-cyan-400">Never</span>&gt;([])

    <span class="text-pink-400">var</span> cartItemsPublisher: <span class="text-cyan-400">AnyPublisher</span>&lt;[<span class="text-cyan-400">CartItem</span>], <span class="text-cyan-400">Never</span>&gt; {
        cartItemsSubject.<span class="text-yellow-300">eraseToAnyPublisher</span>()
    }

    <span class="text-pink-400">var</span> cartItems: [<span class="text-cyan-400">CartItem</span>] {
        cartItemsSubject.value
    }

    <span class="text-pink-400">var</span> totalPrice: <span class="text-cyan-400">Double</span> {
        cartItems.<span class="text-yellow-300">reduce</span>(<span class="text-purple-400">0</span>) { $0 + $1.totalPrice }
    }

    <span class="text-pink-400">var</span> itemsCount: <span class="text-cyan-400">Int</span> {
        cartItems.<span class="text-yellow-300">reduce</span>(<span class="text-purple-400">0</span>) { $0 + $1.quantity }
    }

    <span class="text-pink-400">private var</span> userId: <span class="text-cyan-400">String</span>? {
        <span class="text-cyan-400">Auth</span>.<span class="text-yellow-300">auth</span>().currentUser?.uid
    }

    <span class="text-pink-400">private func</span> <span class="text-yellow-300">cartCollection</span>() -> <span class="text-cyan-400">CollectionReference</span>? {
        <span class="text-pink-400">guard let</span> userId = userId <span class="text-pink-400">else</span> { <span class="text-pink-400">return nil</span> }
        <span class="text-pink-400">return</span> db.<span class="text-yellow-300">collection</span>(<span class="text-green-400">"users"</span>).<span class="text-yellow-300">document</span>(userId).<span class="text-yellow-300">collection</span>(<span class="text-green-400">"cart"</span>)
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">addToCart</span>(<span class="text-purple-400">_</span> product: <span class="text-cyan-400">Product</span>) <span class="text-pink-400">async throws</span> {
        <span class="text-pink-400">guard let</span> collection = <span class="text-yellow-300">cartCollection</span>(),
              <span class="text-pink-400">let</span> productId = product.id <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }

        <span class="text-zinc-500">// Проверяем, есть ли товар в корзине</span>
        <span class="text-pink-400">let</span> existingItems = <span class="text-pink-400">try await</span> collection
            .<span class="text-yellow-300">whereField</span>(<span class="text-green-400">"productId"</span>, isEqualTo: productId)
            .<span class="text-yellow-300">getDocuments</span>()

        <span class="text-pink-400">if let</span> existingDoc = existingItems.documents.first {
            <span class="text-zinc-500">// Увеличиваем количество</span>
            <span class="text-pink-400">let</span> currentQuantity = existingDoc.data()[<span class="text-green-400">"quantity"</span>] <span class="text-pink-400">as?</span> <span class="text-cyan-400">Int</span> ?? <span class="text-purple-400">1</span>
            <span class="text-pink-400">try await</span> existingDoc.reference.<span class="text-yellow-300">updateData</span>([
                <span class="text-green-400">"quantity"</span>: currentQuantity + <span class="text-purple-400">1</span>
            ])
        } <span class="text-pink-400">else</span> {
            <span class="text-zinc-500">// Добавляем новый товар</span>
            <span class="text-pink-400">let</span> cartItem = <span class="text-cyan-400">CartItem</span>(
                productId: productId,
                productName: product.name,
                productImageURL: product.imageURL,
                price: product.price,
                quantity: <span class="text-purple-400">1</span>,
                addedAt: <span class="text-cyan-400">Date</span>()
            )

            <span class="text-pink-400">try</span> collection.<span class="text-yellow-300">addDocument</span>(from: cartItem)
        }
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">updateQuantity</span>(itemId: <span class="text-cyan-400">String</span>, quantity: <span class="text-cyan-400">Int</span>) <span class="text-pink-400">async throws</span> {
        <span class="text-pink-400">guard let</span> collection = <span class="text-yellow-300">cartCollection</span>() <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }

        <span class="text-pink-400">if</span> quantity <= <span class="text-purple-400">0</span> {
            <span class="text-pink-400">try await</span> <span class="text-yellow-300">removeFromCart</span>(itemId: itemId)
        } <span class="text-pink-400">else</span> {
            <span class="text-pink-400">try await</span> collection.<span class="text-yellow-300">document</span>(itemId).<span class="text-yellow-300">updateData</span>([
                <span class="text-green-400">"quantity"</span>: quantity
            ])
        }
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">removeFromCart</span>(itemId: <span class="text-cyan-400">String</span>) <span class="text-pink-400">async throws</span> {
        <span class="text-pink-400">guard let</span> collection = <span class="text-yellow-300">cartCollection</span>() <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }
        <span class="text-pink-400">try await</span> collection.<span class="text-yellow-300">document</span>(itemId).<span class="text-yellow-300">delete</span>()
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">clearCart</span>() <span class="text-pink-400">async throws</span> {
        <span class="text-pink-400">guard let</span> collection = <span class="text-yellow-300">cartCollection</span>() <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }

        <span class="text-pink-400">let</span> documents = <span class="text-pink-400">try await</span> collection.<span class="text-yellow-300">getDocuments</span>()
        <span class="text-pink-400">for</span> doc <span class="text-pink-400">in</span> documents.documents {
            <span class="text-pink-400">try await</span> doc.reference.<span class="text-yellow-300">delete</span>()
        }
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">startListening</span>() {
        <span class="text-pink-400">guard let</span> collection = <span class="text-yellow-300">cartCollection</span>() <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }

        listener = collection
            .<span class="text-yellow-300">order</span>(by: <span class="text-green-400">"addedAt"</span>, descending: <span class="text-pink-400">true</span>)
            .<span class="text-yellow-300">addSnapshotListener</span> { [<span class="text-pink-400">weak self</span>] snapshot, error <span class="text-pink-400">in</span>
                <span class="text-pink-400">guard let</span> documents = snapshot?.documents <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }

                <span class="text-pink-400">let</span> items = documents.<span class="text-yellow-300">compactMap</span> { doc -> <span class="text-cyan-400">CartItem</span>? <span class="text-pink-400">in</span>
                    <span class="text-pink-400">try?</span> doc.<span class="text-yellow-300">data</span>(as: <span class="text-cyan-400">CartItem</span>.<span class="text-pink-400">self</span>)
                }

                <span class="text-pink-400">self</span>?.cartItemsSubject.<span class="text-yellow-300">send</span>(items)
            }
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">stopListening</span>() {
        listener?.<span class="text-yellow-300">remove</span>()
        listener = <span class="text-pink-400">nil</span>
    }
}
</pre>
                    </div>

                    <!-- Cart Protocols -->
                    <h2 class="text-2xl font-bold mt-12 mb-6">Cart Module - Протоколы</h2>

                    <div class="bg-zinc-900 rounded-xl p-6 mb-8 font-mono text-sm overflow-x-auto">
<pre class="text-zinc-300">
<span class="text-zinc-500">// CartProtocols.swift</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">UIKit</span>

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">CartViewProtocol</span>: <span class="text-cyan-400">AnyObject</span> {
    <span class="text-pink-400">var</span> presenter: <span class="text-cyan-400">CartPresenterProtocol</span>? { <span class="text-pink-400">get set</span> }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">showCartItems</span>(<span class="text-purple-400">_</span> items: [<span class="text-cyan-400">CartItem</span>])
    <span class="text-pink-400">func</span> <span class="text-yellow-300">updateTotalPrice</span>(<span class="text-purple-400">_</span> price: <span class="text-cyan-400">String</span>)
    <span class="text-pink-400">func</span> <span class="text-yellow-300">showEmptyCart</span>()
    <span class="text-pink-400">func</span> <span class="text-yellow-300">showError</span>(<span class="text-purple-400">_</span> message: <span class="text-cyan-400">String</span>)
}

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">CartPresenterProtocol</span>: <span class="text-cyan-400">AnyObject</span> {
    <span class="text-pink-400">var</span> view: <span class="text-cyan-400">CartViewProtocol</span>? { <span class="text-pink-400">get set</span> }
    <span class="text-pink-400">var</span> interactor: <span class="text-cyan-400">CartInteractorInputProtocol</span>? { <span class="text-pink-400">get set</span> }
    <span class="text-pink-400">var</span> router: <span class="text-cyan-400">CartRouterProtocol</span>? { <span class="text-pink-400">get set</span> }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">viewDidLoad</span>()
    <span class="text-pink-400">func</span> <span class="text-yellow-300">viewWillDisappear</span>()
    <span class="text-pink-400">func</span> <span class="text-yellow-300">increaseQuantity</span>(for item: <span class="text-cyan-400">CartItem</span>)
    <span class="text-pink-400">func</span> <span class="text-yellow-300">decreaseQuantity</span>(for item: <span class="text-cyan-400">CartItem</span>)
    <span class="text-pink-400">func</span> <span class="text-yellow-300">removeItem</span>(<span class="text-purple-400">_</span> item: <span class="text-cyan-400">CartItem</span>)
    <span class="text-pink-400">func</span> <span class="text-yellow-300">checkoutTapped</span>()
}

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">CartInteractorInputProtocol</span>: <span class="text-cyan-400">AnyObject</span> {
    <span class="text-pink-400">var</span> presenter: <span class="text-cyan-400">CartInteractorOutputProtocol</span>? { <span class="text-pink-400">get set</span> }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">startObservingCart</span>()
    <span class="text-pink-400">func</span> <span class="text-yellow-300">stopObservingCart</span>()
    <span class="text-pink-400">func</span> <span class="text-yellow-300">updateQuantity</span>(itemId: <span class="text-cyan-400">String</span>, quantity: <span class="text-cyan-400">Int</span>)
    <span class="text-pink-400">func</span> <span class="text-yellow-300">removeItem</span>(itemId: <span class="text-cyan-400">String</span>)
}

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">CartInteractorOutputProtocol</span>: <span class="text-cyan-400">AnyObject</span> {
    <span class="text-pink-400">func</span> <span class="text-yellow-300">cartDidUpdate</span>(<span class="text-purple-400">_</span> items: [<span class="text-cyan-400">CartItem</span>])
    <span class="text-pink-400">func</span> <span class="text-yellow-300">didFailWithError</span>(<span class="text-purple-400">_</span> error: <span class="text-cyan-400">Error</span>)
}

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">CartRouterProtocol</span>: <span class="text-cyan-400">AnyObject</span> {
    <span class="text-pink-400">static func</span> <span class="text-yellow-300">createModule</span>() -> <span class="text-cyan-400">UIViewController</span>
    <span class="text-pink-400">func</span> <span class="text-yellow-300">navigateToCheckout</span>(items: [<span class="text-cyan-400">CartItem</span>])
}
</pre>
                    </div>

                    <!-- CartViewController -->
                    <h2 class="text-2xl font-bold mt-12 mb-6">CartViewController</h2>

                    <div class="bg-zinc-900 rounded-xl p-6 mb-8 font-mono text-sm overflow-x-auto">
<pre class="text-zinc-300">
<span class="text-zinc-500">// CartViewController.swift</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">UIKit</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">SnapKit</span>

<span class="text-pink-400">final class</span> <span class="text-cyan-400">CartViewController</span>: <span class="text-cyan-400">UIViewController</span> {

    <span class="text-pink-400">var</span> presenter: <span class="text-cyan-400">CartPresenterProtocol</span>?
    <span class="text-pink-400">private var</span> cartItems: [<span class="text-cyan-400">CartItem</span>] = []

    <span class="text-zinc-500">// MARK: - UI Elements</span>

    <span class="text-pink-400">private lazy var</span> tableView: <span class="text-cyan-400">UITableView</span> = {
        <span class="text-pink-400">let</span> tv = <span class="text-cyan-400">UITableView</span>()
        tv.<span class="text-yellow-300">register</span>(<span class="text-cyan-400">CartCell</span>.<span class="text-pink-400">self</span>, forCellReuseIdentifier: <span class="text-cyan-400">CartCell</span>.reuseId)
        tv.delegate = <span class="text-pink-400">self</span>
        tv.dataSource = <span class="text-pink-400">self</span>
        tv.separatorStyle = .none
        tv.rowHeight = <span class="text-cyan-400">UITableView</span>.automaticDimension
        tv.estimatedRowHeight = <span class="text-purple-400">120</span>
        <span class="text-pink-400">return</span> tv
    }()

    <span class="text-pink-400">private let</span> emptyStateView: <span class="text-cyan-400">UIView</span> = {
        <span class="text-pink-400">let</span> view = <span class="text-cyan-400">UIView</span>()
        view.isHidden = <span class="text-pink-400">true</span>
        <span class="text-pink-400">return</span> view
    }()

    <span class="text-pink-400">private let</span> emptyImageView: <span class="text-cyan-400">UIImageView</span> = {
        <span class="text-pink-400">let</span> iv = <span class="text-cyan-400">UIImageView</span>()
        iv.image = <span class="text-cyan-400">UIImage</span>(systemName: <span class="text-green-400">"cart"</span>)
        iv.tintColor = .<span class="text-purple-400">systemGray3</span>
        iv.contentMode = .scaleAspectFit
        <span class="text-pink-400">return</span> iv
    }()

    <span class="text-pink-400">private let</span> emptyLabel: <span class="text-cyan-400">UILabel</span> = {
        <span class="text-pink-400">let</span> label = <span class="text-cyan-400">UILabel</span>()
        label.text = <span class="text-green-400">"Корзина пуста"</span>
        label.font = .<span class="text-yellow-300">systemFont</span>(ofSize: <span class="text-purple-400">18</span>, weight: .medium)
        label.textColor = .<span class="text-purple-400">secondaryLabel</span>
        label.textAlignment = .center
        <span class="text-pink-400">return</span> label
    }()

    <span class="text-pink-400">private let</span> bottomView: <span class="text-cyan-400">UIView</span> = {
        <span class="text-pink-400">let</span> view = <span class="text-cyan-400">UIView</span>()
        view.backgroundColor = .<span class="text-purple-400">systemBackground</span>
        <span class="text-pink-400">return</span> view
    }()

    <span class="text-pink-400">private let</span> totalLabel: <span class="text-cyan-400">UILabel</span> = {
        <span class="text-pink-400">let</span> label = <span class="text-cyan-400">UILabel</span>()
        label.text = <span class="text-green-400">"Итого:"</span>
        label.font = .<span class="text-yellow-300">systemFont</span>(ofSize: <span class="text-purple-400">16</span>)
        <span class="text-pink-400">return</span> label
    }()

    <span class="text-pink-400">private let</span> totalPriceLabel: <span class="text-cyan-400">UILabel</span> = {
        <span class="text-pink-400">let</span> label = <span class="text-cyan-400">UILabel</span>()
        label.font = .<span class="text-yellow-300">systemFont</span>(ofSize: <span class="text-purple-400">24</span>, weight: .bold)
        label.textColor = .<span class="text-purple-400">systemBlue</span>
        <span class="text-pink-400">return</span> label
    }()

    <span class="text-pink-400">private let</span> checkoutButton: <span class="text-cyan-400">UIButton</span> = {
        <span class="text-pink-400">let</span> button = <span class="text-cyan-400">UIButton</span>(type: .system)
        button.<span class="text-yellow-300">setTitle</span>(<span class="text-green-400">"Оформить заказ"</span>, for: .normal)
        button.<span class="text-yellow-300">setTitleColor</span>(.white, for: .normal)
        button.titleLabel?.font = .<span class="text-yellow-300">systemFont</span>(ofSize: <span class="text-purple-400">18</span>, weight: .semibold)
        button.backgroundColor = .<span class="text-purple-400">systemBlue</span>
        button.layer.cornerRadius = <span class="text-purple-400">14</span>
        <span class="text-pink-400">return</span> button
    }()

    <span class="text-zinc-500">// MARK: - Lifecycle</span>

    <span class="text-pink-400">override func</span> <span class="text-yellow-300">viewDidLoad</span>() {
        <span class="text-pink-400">super</span>.<span class="text-yellow-300">viewDidLoad</span>()
        <span class="text-yellow-300">setupUI</span>()
        <span class="text-yellow-300">setupActions</span>()
        presenter?.<span class="text-yellow-300">viewDidLoad</span>()
    }

    <span class="text-pink-400">override func</span> <span class="text-yellow-300">viewWillDisappear</span>(<span class="text-purple-400">_</span> animated: <span class="text-cyan-400">Bool</span>) {
        <span class="text-pink-400">super</span>.<span class="text-yellow-300">viewWillDisappear</span>(animated)
        presenter?.<span class="text-yellow-300">viewWillDisappear</span>()
    }

    <span class="text-zinc-500">// MARK: - Setup</span>

    <span class="text-pink-400">private func</span> <span class="text-yellow-300">setupUI</span>() {
        title = <span class="text-green-400">"Корзина"</span>
        view.backgroundColor = .<span class="text-purple-400">systemBackground</span>

        view.<span class="text-yellow-300">addSubview</span>(tableView)
        view.<span class="text-yellow-300">addSubview</span>(emptyStateView)
        view.<span class="text-yellow-300">addSubview</span>(bottomView)

        emptyStateView.<span class="text-yellow-300">addSubview</span>(emptyImageView)
        emptyStateView.<span class="text-yellow-300">addSubview</span>(emptyLabel)

        bottomView.<span class="text-yellow-300">addSubview</span>(totalLabel)
        bottomView.<span class="text-yellow-300">addSubview</span>(totalPriceLabel)
        bottomView.<span class="text-yellow-300">addSubview</span>(checkoutButton)

        tableView.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.top.leading.trailing.equalToSuperview()
            make.bottom.equalTo(bottomView.snp.top)
        }

        emptyStateView.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.center.equalToSuperview()
        }

        emptyImageView.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.top.centerX.equalToSuperview()
            make.size.equalTo(<span class="text-purple-400">80</span>)
        }

        emptyLabel.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.top.equalTo(emptyImageView.snp.bottom).offset(<span class="text-purple-400">16</span>)
            make.centerX.bottom.equalToSuperview()
        }

        bottomView.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.leading.trailing.bottom.equalToSuperview()
        }

        totalLabel.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.top.equalToSuperview().offset(<span class="text-purple-400">16</span>)
            make.leading.equalToSuperview().offset(<span class="text-purple-400">16</span>)
        }

        totalPriceLabel.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.centerY.equalTo(totalLabel)
            make.trailing.equalToSuperview().inset(<span class="text-purple-400">16</span>)
        }

        checkoutButton.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.top.equalTo(totalLabel.snp.bottom).offset(<span class="text-purple-400">16</span>)
            make.leading.trailing.equalToSuperview().inset(<span class="text-purple-400">16</span>)
            make.bottom.equalTo(view.safeAreaLayoutGuide).inset(<span class="text-purple-400">16</span>)
            make.height.equalTo(<span class="text-purple-400">56</span>)
        }
    }

    <span class="text-pink-400">private func</span> <span class="text-yellow-300">setupActions</span>() {
        checkoutButton.<span class="text-yellow-300">addTarget</span>(<span class="text-pink-400">self</span>, action: <span class="text-pink-400">#selector</span>(checkoutTapped), for: .touchUpInside)
    }

    <span class="text-pink-400">@objc private func</span> <span class="text-yellow-300">checkoutTapped</span>() {
        presenter?.<span class="text-yellow-300">checkoutTapped</span>()
    }
}
</pre>
                    </div>

                    <!-- CartCell -->
                    <h2 class="text-2xl font-bold mt-12 mb-6">CartCell</h2>

                    <div class="bg-zinc-900 rounded-xl p-6 mb-8 font-mono text-sm overflow-x-auto">
<pre class="text-zinc-300">
<span class="text-zinc-500">// CartCell.swift</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">UIKit</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">SnapKit</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">Kingfisher</span>

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">CartCellDelegate</span>: <span class="text-cyan-400">AnyObject</span> {
    <span class="text-pink-400">func</span> <span class="text-yellow-300">cartCell</span>(<span class="text-purple-400">_</span> cell: <span class="text-cyan-400">CartCell</span>, didTapIncrease item: <span class="text-cyan-400">CartItem</span>)
    <span class="text-pink-400">func</span> <span class="text-yellow-300">cartCell</span>(<span class="text-purple-400">_</span> cell: <span class="text-cyan-400">CartCell</span>, didTapDecrease item: <span class="text-cyan-400">CartItem</span>)
    <span class="text-pink-400">func</span> <span class="text-yellow-300">cartCell</span>(<span class="text-purple-400">_</span> cell: <span class="text-cyan-400">CartCell</span>, didTapRemove item: <span class="text-cyan-400">CartItem</span>)
}

<span class="text-pink-400">final class</span> <span class="text-cyan-400">CartCell</span>: <span class="text-cyan-400">UITableViewCell</span> {

    <span class="text-pink-400">static let</span> reuseId = <span class="text-green-400">"CartCell"</span>

    <span class="text-pink-400">weak var</span> delegate: <span class="text-cyan-400">CartCellDelegate</span>?
    <span class="text-pink-400">private var</span> cartItem: <span class="text-cyan-400">CartItem</span>?

    <span class="text-pink-400">private let</span> productImageView: <span class="text-cyan-400">UIImageView</span> = {
        <span class="text-pink-400">let</span> iv = <span class="text-cyan-400">UIImageView</span>()
        iv.contentMode = .scaleAspectFill
        iv.clipsToBounds = <span class="text-pink-400">true</span>
        iv.layer.cornerRadius = <span class="text-purple-400">8</span>
        iv.backgroundColor = .<span class="text-purple-400">systemGray6</span>
        <span class="text-pink-400">return</span> iv
    }()

    <span class="text-pink-400">private let</span> nameLabel: <span class="text-cyan-400">UILabel</span> = {
        <span class="text-pink-400">let</span> label = <span class="text-cyan-400">UILabel</span>()
        label.font = .<span class="text-yellow-300">systemFont</span>(ofSize: <span class="text-purple-400">16</span>, weight: .medium)
        label.numberOfLines = <span class="text-purple-400">2</span>
        <span class="text-pink-400">return</span> label
    }()

    <span class="text-pink-400">private let</span> priceLabel: <span class="text-cyan-400">UILabel</span> = {
        <span class="text-pink-400">let</span> label = <span class="text-cyan-400">UILabel</span>()
        label.font = .<span class="text-yellow-300">systemFont</span>(ofSize: <span class="text-purple-400">18</span>, weight: .bold)
        label.textColor = .<span class="text-purple-400">systemBlue</span>
        <span class="text-pink-400">return</span> label
    }()

    <span class="text-pink-400">private let</span> quantityStackView: <span class="text-cyan-400">UIStackView</span> = {
        <span class="text-pink-400">let</span> sv = <span class="text-cyan-400">UIStackView</span>()
        sv.axis = .horizontal
        sv.spacing = <span class="text-purple-400">12</span>
        sv.alignment = .center
        <span class="text-pink-400">return</span> sv
    }()

    <span class="text-pink-400">private let</span> decreaseButton: <span class="text-cyan-400">UIButton</span> = {
        <span class="text-pink-400">let</span> button = <span class="text-cyan-400">UIButton</span>(type: .system)
        button.<span class="text-yellow-300">setImage</span>(<span class="text-cyan-400">UIImage</span>(systemName: <span class="text-green-400">"minus.circle.fill"</span>), for: .normal)
        button.tintColor = .<span class="text-purple-400">systemBlue</span>
        <span class="text-pink-400">return</span> button
    }()

    <span class="text-pink-400">private let</span> quantityLabel: <span class="text-cyan-400">UILabel</span> = {
        <span class="text-pink-400">let</span> label = <span class="text-cyan-400">UILabel</span>()
        label.font = .<span class="text-yellow-300">systemFont</span>(ofSize: <span class="text-purple-400">18</span>, weight: .semibold)
        label.textAlignment = .center
        <span class="text-pink-400">return</span> label
    }()

    <span class="text-pink-400">private let</span> increaseButton: <span class="text-cyan-400">UIButton</span> = {
        <span class="text-pink-400">let</span> button = <span class="text-cyan-400">UIButton</span>(type: .system)
        button.<span class="text-yellow-300">setImage</span>(<span class="text-cyan-400">UIImage</span>(systemName: <span class="text-green-400">"plus.circle.fill"</span>), for: .normal)
        button.tintColor = .<span class="text-purple-400">systemBlue</span>
        <span class="text-pink-400">return</span> button
    }()

    <span class="text-pink-400">private let</span> removeButton: <span class="text-cyan-400">UIButton</span> = {
        <span class="text-pink-400">let</span> button = <span class="text-cyan-400">UIButton</span>(type: .system)
        button.<span class="text-yellow-300">setImage</span>(<span class="text-cyan-400">UIImage</span>(systemName: <span class="text-green-400">"trash"</span>), for: .normal)
        button.tintColor = .<span class="text-purple-400">systemRed</span>
        <span class="text-pink-400">return</span> button
    }()

    <span class="text-pink-400">override init</span>(style: <span class="text-cyan-400">UITableViewCell</span>.<span class="text-cyan-400">CellStyle</span>, reuseIdentifier: <span class="text-cyan-400">String</span>?) {
        <span class="text-pink-400">super</span>.<span class="text-pink-400">init</span>(style: style, reuseIdentifier: reuseIdentifier)
        <span class="text-yellow-300">setupUI</span>()
        <span class="text-yellow-300">setupActions</span>()
    }

    <span class="text-pink-400">required init?</span>(coder: <span class="text-cyan-400">NSCoder</span>) {
        <span class="text-pink-400">fatalError</span>(<span class="text-green-400">"init(coder:) has not been implemented"</span>)
    }

    <span class="text-pink-400">private func</span> <span class="text-yellow-300">setupUI</span>() {
        selectionStyle = .none

        contentView.<span class="text-yellow-300">addSubview</span>(productImageView)
        contentView.<span class="text-yellow-300">addSubview</span>(nameLabel)
        contentView.<span class="text-yellow-300">addSubview</span>(priceLabel)
        contentView.<span class="text-yellow-300">addSubview</span>(quantityStackView)
        contentView.<span class="text-yellow-300">addSubview</span>(removeButton)

        quantityStackView.<span class="text-yellow-300">addArrangedSubview</span>(decreaseButton)
        quantityStackView.<span class="text-yellow-300">addArrangedSubview</span>(quantityLabel)
        quantityStackView.<span class="text-yellow-300">addArrangedSubview</span>(increaseButton)

        productImageView.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.leading.equalToSuperview().offset(<span class="text-purple-400">16</span>)
            make.top.bottom.equalToSuperview().inset(<span class="text-purple-400">12</span>)
            make.size.equalTo(<span class="text-purple-400">80</span>)
        }

        nameLabel.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.top.equalTo(productImageView)
            make.leading.equalTo(productImageView.snp.trailing).offset(<span class="text-purple-400">12</span>)
            make.trailing.equalTo(removeButton.snp.leading).offset(-<span class="text-purple-400">8</span>)
        }

        priceLabel.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.top.equalTo(nameLabel.snp.bottom).offset(<span class="text-purple-400">4</span>)
            make.leading.equalTo(nameLabel)
        }

        quantityStackView.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.top.equalTo(priceLabel.snp.bottom).offset(<span class="text-purple-400">8</span>)
            make.leading.equalTo(nameLabel)
        }

        removeButton.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.trailing.equalToSuperview().inset(<span class="text-purple-400">16</span>)
            make.centerY.equalToSuperview()
            make.size.equalTo(<span class="text-purple-400">32</span>)
        }

        [decreaseButton, increaseButton].<span class="text-yellow-300">forEach</span> {
            $0.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
                make.size.equalTo(<span class="text-purple-400">28</span>)
            }
        }

        quantityLabel.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.width.greaterThanOrEqualTo(<span class="text-purple-400">24</span>)
        }
    }

    <span class="text-pink-400">private func</span> <span class="text-yellow-300">setupActions</span>() {
        decreaseButton.<span class="text-yellow-300">addTarget</span>(<span class="text-pink-400">self</span>, action: <span class="text-pink-400">#selector</span>(decreaseTapped), for: .touchUpInside)
        increaseButton.<span class="text-yellow-300">addTarget</span>(<span class="text-pink-400">self</span>, action: <span class="text-pink-400">#selector</span>(increaseTapped), for: .touchUpInside)
        removeButton.<span class="text-yellow-300">addTarget</span>(<span class="text-pink-400">self</span>, action: <span class="text-pink-400">#selector</span>(removeTapped), for: .touchUpInside)
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">configure</span>(with item: <span class="text-cyan-400">CartItem</span>) {
        <span class="text-pink-400">self</span>.cartItem = item
        nameLabel.text = item.productName
        priceLabel.text = item.formattedTotalPrice
        quantityLabel.text = <span class="text-green-400">"\(item.quantity)"</span>

        <span class="text-pink-400">if let</span> url = <span class="text-cyan-400">URL</span>(string: item.productImageURL) {
            productImageView.kf.<span class="text-yellow-300">setImage</span>(with: url)
        }
    }

    <span class="text-pink-400">@objc private func</span> <span class="text-yellow-300">decreaseTapped</span>() {
        <span class="text-pink-400">guard let</span> item = cartItem <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }
        delegate?.<span class="text-yellow-300">cartCell</span>(<span class="text-pink-400">self</span>, didTapDecrease: item)
    }

    <span class="text-pink-400">@objc private func</span> <span class="text-yellow-300">increaseTapped</span>() {
        <span class="text-pink-400">guard let</span> item = cartItem <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }
        delegate?.<span class="text-yellow-300">cartCell</span>(<span class="text-pink-400">self</span>, didTapIncrease: item)
    }

    <span class="text-pink-400">@objc private func</span> <span class="text-yellow-300">removeTapped</span>() {
        <span class="text-pink-400">guard let</span> item = cartItem <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }
        delegate?.<span class="text-yellow-300">cartCell</span>(<span class="text-pink-400">self</span>, didTapRemove: item)
    }
}
</pre>
                    </div>

                    <!-- Cart Presenter -->
                    <h2 class="text-2xl font-bold mt-12 mb-6">CartPresenter</h2>

                    <div class="bg-zinc-900 rounded-xl p-6 mb-8 font-mono text-sm overflow-x-auto">
<pre class="text-zinc-300">
<span class="text-zinc-500">// CartPresenter.swift</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">Foundation</span>

<span class="text-pink-400">final class</span> <span class="text-cyan-400">CartPresenter</span>: <span class="text-cyan-400">CartPresenterProtocol</span> {

    <span class="text-pink-400">weak var</span> view: <span class="text-cyan-400">CartViewProtocol</span>?
    <span class="text-pink-400">var</span> interactor: <span class="text-cyan-400">CartInteractorInputProtocol</span>?
    <span class="text-pink-400">var</span> router: <span class="text-cyan-400">CartRouterProtocol</span>?

    <span class="text-pink-400">private var</span> cartItems: [<span class="text-cyan-400">CartItem</span>] = []

    <span class="text-pink-400">func</span> <span class="text-yellow-300">viewDidLoad</span>() {
        interactor?.<span class="text-yellow-300">startObservingCart</span>()
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">viewWillDisappear</span>() {
        interactor?.<span class="text-yellow-300">stopObservingCart</span>()
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">increaseQuantity</span>(for item: <span class="text-cyan-400">CartItem</span>) {
        <span class="text-pink-400">guard let</span> id = item.id <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }
        interactor?.<span class="text-yellow-300">updateQuantity</span>(itemId: id, quantity: item.quantity + <span class="text-purple-400">1</span>)
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">decreaseQuantity</span>(for item: <span class="text-cyan-400">CartItem</span>) {
        <span class="text-pink-400">guard let</span> id = item.id <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }
        interactor?.<span class="text-yellow-300">updateQuantity</span>(itemId: id, quantity: item.quantity - <span class="text-purple-400">1</span>)
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">removeItem</span>(<span class="text-purple-400">_</span> item: <span class="text-cyan-400">CartItem</span>) {
        <span class="text-pink-400">guard let</span> id = item.id <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }
        interactor?.<span class="text-yellow-300">removeItem</span>(itemId: id)
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">checkoutTapped</span>() {
        <span class="text-pink-400">guard</span> !cartItems.isEmpty <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }
        router?.<span class="text-yellow-300">navigateToCheckout</span>(items: cartItems)
    }

    <span class="text-pink-400">private func</span> <span class="text-yellow-300">calculateTotal</span>() -> <span class="text-cyan-400">Double</span> {
        cartItems.<span class="text-yellow-300">reduce</span>(<span class="text-purple-400">0</span>) { $0 + $1.totalPrice }
    }
}

<span class="text-zinc-500">// MARK: - CartInteractorOutputProtocol</span>
<span class="text-pink-400">extension</span> <span class="text-cyan-400">CartPresenter</span>: <span class="text-cyan-400">CartInteractorOutputProtocol</span> {

    <span class="text-pink-400">func</span> <span class="text-yellow-300">cartDidUpdate</span>(<span class="text-purple-400">_</span> items: [<span class="text-cyan-400">CartItem</span>]) {
        cartItems = items

        <span class="text-pink-400">if</span> items.isEmpty {
            view?.<span class="text-yellow-300">showEmptyCart</span>()
        } <span class="text-pink-400">else</span> {
            view?.<span class="text-yellow-300">showCartItems</span>(items)
        }

        <span class="text-pink-400">let</span> total = <span class="text-yellow-300">calculateTotal</span>()
        view?.<span class="text-yellow-300">updateTotalPrice</span>(<span class="text-cyan-400">String</span>(format: <span class="text-green-400">"%.0f ₸"</span>, total))
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">didFailWithError</span>(<span class="text-purple-400">_</span> error: <span class="text-cyan-400">Error</span>) {
        view?.<span class="text-yellow-300">showError</span>(<span class="text-green-400">"Произошла ошибка"</span>)
    }
}
</pre>
                    </div>

                    <!-- Summary -->
                    <div class="mt-16 p-8 bg-gradient-to-br from-primary/10 to-purple-500/10 rounded-2xl border border-primary/20">
                        <h3 class="text-xl font-bold mb-6">Что вы узнали</h3>
                        <div class="grid gap-4">
                            <div class="flex items-start gap-3">
                                <div class="w-6 h-6 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <svg class="w-3 h-3 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <p class="text-zinc-600 dark:text-zinc-400">Работа с подколлекциями в Firestore</p>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-6 h-6 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <svg class="w-3 h-3 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <p class="text-zinc-600 dark:text-zinc-400">Realtime listeners для обновления корзины</p>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-6 h-6 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <svg class="w-3 h-3 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <p class="text-zinc-600 dark:text-zinc-400">Combine для реактивных обновлений</p>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-6 h-6 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <svg class="w-3 h-3 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <p class="text-zinc-600 dark:text-zinc-400">Delegate паттерн для взаимодействия с ячейками</p>
                            </div>
                        </div>
                    </div>

                    <!-- Next Chapter Preview -->
                    <div class="mt-8 p-6 bg-zinc-100 dark:bg-zinc-800/50 rounded-2xl">
                        <h4 class="font-semibold mb-2">Следующая глава</h4>
                        <p class="text-zinc-600 dark:text-zinc-400">
                            В следующей главе мы создадим модуль избранного — научимся сохранять
                            понравившиеся товары и синхронизировать их с Firestore.
                        </p>
                    </div>
                </div>

                <nav class="flex justify-between gap-4 mt-16 pt-8 border-t border-zinc-200 dark:border-zinc-800">
                    <a href="16-products.html" class="flex items-center gap-3 px-5 py-3 bg-zinc-100 dark:bg-zinc-800 hover:bg-primary hover:text-white rounded-xl transition-colors">
                        <span class="text-xl">←</span>
                        <span class="font-medium">Предыдущая</span>
                    </a>
                    <a href="18-favorites.html" class="flex items-center gap-3 px-5 py-3 bg-zinc-100 dark:bg-zinc-800 hover:bg-primary hover:text-white rounded-xl transition-colors ml-auto">
                        <span class="font-medium">Следующая</span>
                        <span class="text-xl">→</span>
                    </a>
                </nav>
            </article>
        </main>
    </div>

    <script>
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        });
        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }
    </script>
</body>
</html>