<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Глава 18: Favorites | iOS Book</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: { extend: { colors: { primary: '#007AFF' } } }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
</head>
<body class="bg-white dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100">
    <button id="menuBtn" class="lg:hidden fixed top-4 left-4 z-50 p-3 bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-xl shadow-lg">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </button>

    <div class="flex min-h-screen">
        <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-zinc-50 dark:bg-zinc-900 border-r border-zinc-200 dark:border-zinc-800 flex flex-col z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
            <div class="p-5 border-b border-zinc-200 dark:border-zinc-800">
                <a href="../index.html" class="flex items-center gap-3 text-lg font-semibold hover:text-primary transition-colors">
                    <div class="w-9 h-9 bg-primary rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    iOS Book
                </a>
            </div>
            <nav class="flex-1 overflow-y-auto p-4">
                <div class="space-y-6">
                    <div>
                        <h3 class="px-3 mb-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">Введение</h3>
                        <a href="00-introduction.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">Введение</a>
                    </div>
                    <div>
                        <h3 class="px-3 mb-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">Основы Swift</h3>
                        <div class="space-y-1">
                            <a href="01-xcode.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">1. Xcode</a>
                            <a href="02-swift-basics.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">2. Основы Swift</a>
                            <a href="03-control-flow.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">3. Control Flow</a>
                            <a href="04-functions.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">4. Функции</a>
                            <a href="05-oop.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">5. ООП</a>
                            <a href="06-protocols.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">6. Протоколы</a>
                            <a href="07-optionals.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">7. Optionals</a>
                            <a href="08-memory.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">8. Память</a>
                            <a href="09-generics.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">9. Generics</a>
                            <a href="10-concurrency.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">10. Concurrency</a>
                        </div>
                    </div>
                    <div>
                        <h3 class="px-3 mb-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">UIKit</h3>
                        <div class="space-y-1">
                            <a href="11-uikit-basics.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">11. UIKit</a>
                            <a href="12-programmatic-ui.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">12. Programmatic UI</a>
                        </div>
                    </div>
                    <div>
                        <h3 class="px-3 mb-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">Архитектура</h3>
                        <div class="space-y-1">
                            <a href="13-viper.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">13. VIPER</a>
                            <a href="14-project-setup.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">14. Project Setup</a>
                        </div>
                    </div>
                    <div>
                        <h3 class="px-3 mb-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">Практика</h3>
                        <div class="space-y-1">
                            <a href="15-authentication.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">15. Auth</a>
                            <a href="16-products.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">16. Products</a>
                            <a href="17-cart.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">17. Cart</a>
                            <a href="18-favorites.html" class="block px-3 py-2 text-sm text-white bg-primary rounded-lg">18. Favorites</a>
                            <a href="19-orders.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">19. Orders</a>
                            <a href="20-profile.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">20. Profile</a>
                        </div>
                    </div>
                    <div>
                        <h3 class="px-3 mb-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">Дополнительно</h3>
                        <a href="21-reusable-views.html" class="block px-3 py-2 text-sm text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200/50 dark:hover:bg-zinc-800 rounded-lg">21. Reusable Views</a>
                    </div>
                </div>
            </nav>
        </aside>

        <div id="overlay" class="fixed inset-0 bg-black/50 z-30 lg:hidden hidden" onclick="closeSidebar()"></div>

        <main class="flex-1 lg:ml-72">
            <article class="max-w-3xl mx-auto px-6 sm:px-8 lg:px-12 py-12 lg:py-16">
                <header class="mb-12 pb-8 border-b border-zinc-200 dark:border-zinc-800">
                    <span class="text-sm font-semibold uppercase tracking-wider text-primary">Глава 18</span>
                    <h1 class="text-3xl sm:text-4xl font-bold mt-2 mb-4">Favorites</h1>
                    <p class="text-lg text-zinc-600 dark:text-zinc-400">Избранное, Realm Database</p>
                </header>

                <div class="prose prose-zinc dark:prose-invert max-w-none">
                    <!-- Введение -->
                    <p class="text-lg leading-relaxed mb-8">
                        Функция избранного позволяет пользователям сохранять понравившиеся товары для быстрого доступа.
                        В этой главе мы реализуем модуль избранного с использованием Firestore и паттерна VIPER.
                    </p>

                    <!-- FavoriteItem Model -->
                    <h2 class="text-2xl font-bold mt-12 mb-6">Модель FavoriteItem</h2>

                    <div class="bg-zinc-900 rounded-xl p-6 mb-8 font-mono text-sm overflow-x-auto">
<pre class="text-zinc-300">
<span class="text-zinc-500">// FavoriteItem.swift</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">Foundation</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">FirebaseFirestore</span>

<span class="text-pink-400">struct</span> <span class="text-cyan-400">FavoriteItem</span>: <span class="text-cyan-400">Identifiable</span>, <span class="text-cyan-400">Codable</span> {
    <span class="text-pink-400">@DocumentID var</span> id: <span class="text-cyan-400">String</span>?
    <span class="text-pink-400">let</span> productId: <span class="text-cyan-400">String</span>
    <span class="text-pink-400">let</span> productName: <span class="text-cyan-400">String</span>
    <span class="text-pink-400">let</span> productImageURL: <span class="text-cyan-400">String</span>
    <span class="text-pink-400">let</span> price: <span class="text-cyan-400">Double</span>
    <span class="text-pink-400">let</span> addedAt: <span class="text-cyan-400">Date</span>

    <span class="text-pink-400">var</span> formattedPrice: <span class="text-cyan-400">String</span> {
        <span class="text-cyan-400">String</span>(format: <span class="text-green-400">"%.0f ₸"</span>, price)
    }
}
</pre>
                    </div>

                    <!-- FavoritesService -->
                    <h2 class="text-2xl font-bold mt-12 mb-6">FavoritesService</h2>

                    <div class="bg-zinc-900 rounded-xl p-6 mb-8 font-mono text-sm overflow-x-auto">
<pre class="text-zinc-300">
<span class="text-zinc-500">// FavoritesService.swift</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">Foundation</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">FirebaseFirestore</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">FirebaseAuth</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">Combine</span>

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">FavoritesServiceProtocol</span> {
    <span class="text-pink-400">var</span> favoritesPublisher: <span class="text-cyan-400">AnyPublisher</span>&lt;[<span class="text-cyan-400">FavoriteItem</span>], <span class="text-cyan-400">Never</span>&gt; { <span class="text-pink-400">get</span> }
    <span class="text-pink-400">var</span> favorites: [<span class="text-cyan-400">FavoriteItem</span>] { <span class="text-pink-400">get</span> }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">addToFavorites</span>(<span class="text-purple-400">_</span> product: <span class="text-cyan-400">Product</span>) <span class="text-pink-400">async throws</span>
    <span class="text-pink-400">func</span> <span class="text-yellow-300">removeFromFavorites</span>(productId: <span class="text-cyan-400">String</span>) <span class="text-pink-400">async throws</span>
    <span class="text-pink-400">func</span> <span class="text-yellow-300">isFavorite</span>(productId: <span class="text-cyan-400">String</span>) -> <span class="text-cyan-400">Bool</span>
    <span class="text-pink-400">func</span> <span class="text-yellow-300">toggleFavorite</span>(<span class="text-purple-400">_</span> product: <span class="text-cyan-400">Product</span>) <span class="text-pink-400">async throws</span>
    <span class="text-pink-400">func</span> <span class="text-yellow-300">startListening</span>()
    <span class="text-pink-400">func</span> <span class="text-yellow-300">stopListening</span>()
}

<span class="text-pink-400">final class</span> <span class="text-cyan-400">FavoritesService</span>: <span class="text-cyan-400">FavoritesServiceProtocol</span> {

    <span class="text-pink-400">static let</span> shared = <span class="text-cyan-400">FavoritesService</span>()

    <span class="text-pink-400">private let</span> db = <span class="text-cyan-400">Firestore</span>.<span class="text-yellow-300">firestore</span>()
    <span class="text-pink-400">private var</span> listener: <span class="text-cyan-400">ListenerRegistration</span>?

    <span class="text-pink-400">private let</span> favoritesSubject = <span class="text-cyan-400">CurrentValueSubject</span>&lt;[<span class="text-cyan-400">FavoriteItem</span>], <span class="text-cyan-400">Never</span>&gt;([])

    <span class="text-pink-400">var</span> favoritesPublisher: <span class="text-cyan-400">AnyPublisher</span>&lt;[<span class="text-cyan-400">FavoriteItem</span>], <span class="text-cyan-400">Never</span>&gt; {
        favoritesSubject.<span class="text-yellow-300">eraseToAnyPublisher</span>()
    }

    <span class="text-pink-400">var</span> favorites: [<span class="text-cyan-400">FavoriteItem</span>] {
        favoritesSubject.value
    }

    <span class="text-pink-400">private var</span> userId: <span class="text-cyan-400">String</span>? {
        <span class="text-cyan-400">Auth</span>.<span class="text-yellow-300">auth</span>().currentUser?.uid
    }

    <span class="text-pink-400">private func</span> <span class="text-yellow-300">favoritesCollection</span>() -> <span class="text-cyan-400">CollectionReference</span>? {
        <span class="text-pink-400">guard let</span> userId = userId <span class="text-pink-400">else</span> { <span class="text-pink-400">return nil</span> }
        <span class="text-pink-400">return</span> db.<span class="text-yellow-300">collection</span>(<span class="text-green-400">"users"</span>).<span class="text-yellow-300">document</span>(userId).<span class="text-yellow-300">collection</span>(<span class="text-green-400">"favorites"</span>)
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">addToFavorites</span>(<span class="text-purple-400">_</span> product: <span class="text-cyan-400">Product</span>) <span class="text-pink-400">async throws</span> {
        <span class="text-pink-400">guard let</span> collection = <span class="text-yellow-300">favoritesCollection</span>(),
              <span class="text-pink-400">let</span> productId = product.id <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }

        <span class="text-zinc-500">// Проверяем, не добавлен ли уже</span>
        <span class="text-pink-400">if</span> <span class="text-yellow-300">isFavorite</span>(productId: productId) { <span class="text-pink-400">return</span> }

        <span class="text-pink-400">let</span> favoriteItem = <span class="text-cyan-400">FavoriteItem</span>(
            productId: productId,
            productName: product.name,
            productImageURL: product.imageURL,
            price: product.price,
            addedAt: <span class="text-cyan-400">Date</span>()
        )

        <span class="text-pink-400">try</span> collection.<span class="text-yellow-300">document</span>(productId).<span class="text-yellow-300">setData</span>(from: favoriteItem)
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">removeFromFavorites</span>(productId: <span class="text-cyan-400">String</span>) <span class="text-pink-400">async throws</span> {
        <span class="text-pink-400">guard let</span> collection = <span class="text-yellow-300">favoritesCollection</span>() <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }
        <span class="text-pink-400">try await</span> collection.<span class="text-yellow-300">document</span>(productId).<span class="text-yellow-300">delete</span>()
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">isFavorite</span>(productId: <span class="text-cyan-400">String</span>) -> <span class="text-cyan-400">Bool</span> {
        favorites.<span class="text-yellow-300">contains</span> { $0.productId == productId }
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">toggleFavorite</span>(<span class="text-purple-400">_</span> product: <span class="text-cyan-400">Product</span>) <span class="text-pink-400">async throws</span> {
        <span class="text-pink-400">guard let</span> productId = product.id <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }

        <span class="text-pink-400">if</span> <span class="text-yellow-300">isFavorite</span>(productId: productId) {
            <span class="text-pink-400">try await</span> <span class="text-yellow-300">removeFromFavorites</span>(productId: productId)
        } <span class="text-pink-400">else</span> {
            <span class="text-pink-400">try await</span> <span class="text-yellow-300">addToFavorites</span>(product)
        }
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">startListening</span>() {
        <span class="text-pink-400">guard let</span> collection = <span class="text-yellow-300">favoritesCollection</span>() <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }

        listener = collection
            .<span class="text-yellow-300">order</span>(by: <span class="text-green-400">"addedAt"</span>, descending: <span class="text-pink-400">true</span>)
            .<span class="text-yellow-300">addSnapshotListener</span> { [<span class="text-pink-400">weak self</span>] snapshot, error <span class="text-pink-400">in</span>
                <span class="text-pink-400">guard let</span> documents = snapshot?.documents <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }

                <span class="text-pink-400">let</span> items = documents.<span class="text-yellow-300">compactMap</span> { doc -> <span class="text-cyan-400">FavoriteItem</span>? <span class="text-pink-400">in</span>
                    <span class="text-pink-400">try?</span> doc.<span class="text-yellow-300">data</span>(as: <span class="text-cyan-400">FavoriteItem</span>.<span class="text-pink-400">self</span>)
                }

                <span class="text-pink-400">self</span>?.favoritesSubject.<span class="text-yellow-300">send</span>(items)
            }
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">stopListening</span>() {
        listener?.<span class="text-yellow-300">remove</span>()
        listener = <span class="text-pink-400">nil</span>
    }
}
</pre>
                    </div>

                    <!-- Favorites Protocols -->
                    <h2 class="text-2xl font-bold mt-12 mb-6">Favorites Module - Протоколы</h2>

                    <div class="bg-zinc-900 rounded-xl p-6 mb-8 font-mono text-sm overflow-x-auto">
<pre class="text-zinc-300">
<span class="text-zinc-500">// FavoritesProtocols.swift</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">UIKit</span>

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">FavoritesViewProtocol</span>: <span class="text-cyan-400">AnyObject</span> {
    <span class="text-pink-400">var</span> presenter: <span class="text-cyan-400">FavoritesPresenterProtocol</span>? { <span class="text-pink-400">get set</span> }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">showFavorites</span>(<span class="text-purple-400">_</span> items: [<span class="text-cyan-400">FavoriteItem</span>])
    <span class="text-pink-400">func</span> <span class="text-yellow-300">showEmptyState</span>()
    <span class="text-pink-400">func</span> <span class="text-yellow-300">showError</span>(<span class="text-purple-400">_</span> message: <span class="text-cyan-400">String</span>)
}

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">FavoritesPresenterProtocol</span>: <span class="text-cyan-400">AnyObject</span> {
    <span class="text-pink-400">var</span> view: <span class="text-cyan-400">FavoritesViewProtocol</span>? { <span class="text-pink-400">get set</span> }
    <span class="text-pink-400">var</span> interactor: <span class="text-cyan-400">FavoritesInteractorInputProtocol</span>? { <span class="text-pink-400">get set</span> }
    <span class="text-pink-400">var</span> router: <span class="text-cyan-400">FavoritesRouterProtocol</span>? { <span class="text-pink-400">get set</span> }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">viewDidLoad</span>()
    <span class="text-pink-400">func</span> <span class="text-yellow-300">viewWillDisappear</span>()
    <span class="text-pink-400">func</span> <span class="text-yellow-300">didSelectItem</span>(<span class="text-purple-400">_</span> item: <span class="text-cyan-400">FavoriteItem</span>)
    <span class="text-pink-400">func</span> <span class="text-yellow-300">removeItem</span>(<span class="text-purple-400">_</span> item: <span class="text-cyan-400">FavoriteItem</span>)
    <span class="text-pink-400">func</span> <span class="text-yellow-300">addToCart</span>(<span class="text-purple-400">_</span> item: <span class="text-cyan-400">FavoriteItem</span>)
}

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">FavoritesInteractorInputProtocol</span>: <span class="text-cyan-400">AnyObject</span> {
    <span class="text-pink-400">var</span> presenter: <span class="text-cyan-400">FavoritesInteractorOutputProtocol</span>? { <span class="text-pink-400">get set</span> }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">startObservingFavorites</span>()
    <span class="text-pink-400">func</span> <span class="text-yellow-300">stopObservingFavorites</span>()
    <span class="text-pink-400">func</span> <span class="text-yellow-300">removeFromFavorites</span>(productId: <span class="text-cyan-400">String</span>)
    <span class="text-pink-400">func</span> <span class="text-yellow-300">addToCart</span>(item: <span class="text-cyan-400">FavoriteItem</span>)
}

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">FavoritesInteractorOutputProtocol</span>: <span class="text-cyan-400">AnyObject</span> {
    <span class="text-pink-400">func</span> <span class="text-yellow-300">favoritesDidUpdate</span>(<span class="text-purple-400">_</span> items: [<span class="text-cyan-400">FavoriteItem</span>])
    <span class="text-pink-400">func</span> <span class="text-yellow-300">didAddToCart</span>()
    <span class="text-pink-400">func</span> <span class="text-yellow-300">didFailWithError</span>(<span class="text-purple-400">_</span> error: <span class="text-cyan-400">Error</span>)
}

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">FavoritesRouterProtocol</span>: <span class="text-cyan-400">AnyObject</span> {
    <span class="text-pink-400">static func</span> <span class="text-yellow-300">createModule</span>() -> <span class="text-cyan-400">UIViewController</span>
    <span class="text-pink-400">func</span> <span class="text-yellow-300">navigateToProductDetail</span>(productId: <span class="text-cyan-400">String</span>)
}
</pre>
                    </div>

                    <!-- FavoritesViewController -->
                    <h2 class="text-2xl font-bold mt-12 mb-6">FavoritesViewController</h2>

                    <div class="bg-zinc-900 rounded-xl p-6 mb-8 font-mono text-sm overflow-x-auto">
<pre class="text-zinc-300">
<span class="text-zinc-500">// FavoritesViewController.swift</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">UIKit</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">SnapKit</span>

<span class="text-pink-400">final class</span> <span class="text-cyan-400">FavoritesViewController</span>: <span class="text-cyan-400">UIViewController</span> {

    <span class="text-pink-400">var</span> presenter: <span class="text-cyan-400">FavoritesPresenterProtocol</span>?
    <span class="text-pink-400">private var</span> favorites: [<span class="text-cyan-400">FavoriteItem</span>] = []

    <span class="text-pink-400">private lazy var</span> collectionView: <span class="text-cyan-400">UICollectionView</span> = {
        <span class="text-pink-400">let</span> layout = <span class="text-yellow-300">createLayout</span>()
        <span class="text-pink-400">let</span> cv = <span class="text-cyan-400">UICollectionView</span>(frame: .zero, collectionViewLayout: layout)
        cv.<span class="text-yellow-300">register</span>(<span class="text-cyan-400">FavoriteCell</span>.<span class="text-pink-400">self</span>, forCellWithReuseIdentifier: <span class="text-cyan-400">FavoriteCell</span>.reuseId)
        cv.delegate = <span class="text-pink-400">self</span>
        cv.dataSource = <span class="text-pink-400">self</span>
        cv.backgroundColor = .<span class="text-purple-400">systemBackground</span>
        <span class="text-pink-400">return</span> cv
    }()

    <span class="text-pink-400">private let</span> emptyStateView: <span class="text-cyan-400">EmptyStateView</span> = {
        <span class="text-pink-400">let</span> view = <span class="text-cyan-400">EmptyStateView</span>()
        view.<span class="text-yellow-300">configure</span>(
            image: <span class="text-cyan-400">UIImage</span>(systemName: <span class="text-green-400">"heart"</span>),
            title: <span class="text-green-400">"Нет избранного"</span>,
            message: <span class="text-green-400">"Добавьте товары в избранное"</span>
        )
        view.isHidden = <span class="text-pink-400">true</span>
        <span class="text-pink-400">return</span> view
    }()

    <span class="text-pink-400">override func</span> <span class="text-yellow-300">viewDidLoad</span>() {
        <span class="text-pink-400">super</span>.<span class="text-yellow-300">viewDidLoad</span>()
        <span class="text-yellow-300">setupUI</span>()
        presenter?.<span class="text-yellow-300">viewDidLoad</span>()
    }

    <span class="text-pink-400">override func</span> <span class="text-yellow-300">viewWillDisappear</span>(<span class="text-purple-400">_</span> animated: <span class="text-cyan-400">Bool</span>) {
        <span class="text-pink-400">super</span>.<span class="text-yellow-300">viewWillDisappear</span>(animated)
        presenter?.<span class="text-yellow-300">viewWillDisappear</span>()
    }

    <span class="text-pink-400">private func</span> <span class="text-yellow-300">setupUI</span>() {
        title = <span class="text-green-400">"Избранное"</span>
        view.backgroundColor = .<span class="text-purple-400">systemBackground</span>

        view.<span class="text-yellow-300">addSubview</span>(collectionView)
        view.<span class="text-yellow-300">addSubview</span>(emptyStateView)

        collectionView.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.edges.equalToSuperview()
        }

        emptyStateView.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.center.equalToSuperview()
            make.leading.trailing.equalToSuperview().inset(<span class="text-purple-400">40</span>)
        }
    }

    <span class="text-pink-400">private func</span> <span class="text-yellow-300">createLayout</span>() -> <span class="text-cyan-400">UICollectionViewLayout</span> {
        <span class="text-pink-400">let</span> itemSize = <span class="text-cyan-400">NSCollectionLayoutSize</span>(
            widthDimension: .fractionalWidth(<span class="text-purple-400">0.5</span>),
            heightDimension: .estimated(<span class="text-purple-400">260</span>)
        )
        <span class="text-pink-400">let</span> item = <span class="text-cyan-400">NSCollectionLayoutItem</span>(layoutSize: itemSize)
        item.contentInsets = <span class="text-cyan-400">NSDirectionalEdgeInsets</span>(top: <span class="text-purple-400">8</span>, leading: <span class="text-purple-400">8</span>, bottom: <span class="text-purple-400">8</span>, trailing: <span class="text-purple-400">8</span>)

        <span class="text-pink-400">let</span> groupSize = <span class="text-cyan-400">NSCollectionLayoutSize</span>(
            widthDimension: .fractionalWidth(<span class="text-purple-400">1.0</span>),
            heightDimension: .estimated(<span class="text-purple-400">260</span>)
        )
        <span class="text-pink-400">let</span> group = <span class="text-cyan-400">NSCollectionLayoutGroup</span>.<span class="text-yellow-300">horizontal</span>(layoutSize: groupSize, subitems: [item])

        <span class="text-pink-400">let</span> section = <span class="text-cyan-400">NSCollectionLayoutSection</span>(group: group)
        section.contentInsets = <span class="text-cyan-400">NSDirectionalEdgeInsets</span>(top: <span class="text-purple-400">8</span>, leading: <span class="text-purple-400">8</span>, bottom: <span class="text-purple-400">8</span>, trailing: <span class="text-purple-400">8</span>)

        <span class="text-pink-400">return</span> <span class="text-cyan-400">UICollectionViewCompositionalLayout</span>(section: section)
    }
}

<span class="text-zinc-500">// MARK: - FavoritesViewProtocol</span>
<span class="text-pink-400">extension</span> <span class="text-cyan-400">FavoritesViewController</span>: <span class="text-cyan-400">FavoritesViewProtocol</span> {

    <span class="text-pink-400">func</span> <span class="text-yellow-300">showFavorites</span>(<span class="text-purple-400">_</span> items: [<span class="text-cyan-400">FavoriteItem</span>]) {
        favorites = items
        emptyStateView.isHidden = <span class="text-pink-400">true</span>
        collectionView.isHidden = <span class="text-pink-400">false</span>
        collectionView.<span class="text-yellow-300">reloadData</span>()
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">showEmptyState</span>() {
        emptyStateView.isHidden = <span class="text-pink-400">false</span>
        collectionView.isHidden = <span class="text-pink-400">true</span>
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">showError</span>(<span class="text-purple-400">_</span> message: <span class="text-cyan-400">String</span>) {
        <span class="text-pink-400">let</span> alert = <span class="text-cyan-400">UIAlertController</span>(title: <span class="text-green-400">"Ошибка"</span>, message: message, preferredStyle: .alert)
        alert.<span class="text-yellow-300">addAction</span>(<span class="text-cyan-400">UIAlertAction</span>(title: <span class="text-green-400">"OK"</span>, style: .default))
        <span class="text-yellow-300">present</span>(alert, animated: <span class="text-pink-400">true</span>)
    }
}

<span class="text-zinc-500">// MARK: - UICollectionViewDataSource</span>
<span class="text-pink-400">extension</span> <span class="text-cyan-400">FavoritesViewController</span>: <span class="text-cyan-400">UICollectionViewDataSource</span> {

    <span class="text-pink-400">func</span> <span class="text-yellow-300">collectionView</span>(<span class="text-purple-400">_</span> collectionView: <span class="text-cyan-400">UICollectionView</span>, numberOfItemsInSection section: <span class="text-cyan-400">Int</span>) -> <span class="text-cyan-400">Int</span> {
        favorites.count
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">collectionView</span>(<span class="text-purple-400">_</span> collectionView: <span class="text-cyan-400">UICollectionView</span>, cellForItemAt indexPath: <span class="text-cyan-400">IndexPath</span>) -> <span class="text-cyan-400">UICollectionViewCell</span> {
        <span class="text-pink-400">let</span> cell = collectionView.<span class="text-yellow-300">dequeueReusableCell</span>(
            withReuseIdentifier: <span class="text-cyan-400">FavoriteCell</span>.reuseId,
            for: indexPath
        ) <span class="text-pink-400">as!</span> <span class="text-cyan-400">FavoriteCell</span>

        <span class="text-pink-400">let</span> item = favorites[indexPath.item]
        cell.<span class="text-yellow-300">configure</span>(with: item)
        cell.delegate = <span class="text-pink-400">self</span>

        <span class="text-pink-400">return</span> cell
    }
}

<span class="text-zinc-500">// MARK: - UICollectionViewDelegate</span>
<span class="text-pink-400">extension</span> <span class="text-cyan-400">FavoritesViewController</span>: <span class="text-cyan-400">UICollectionViewDelegate</span> {

    <span class="text-pink-400">func</span> <span class="text-yellow-300">collectionView</span>(<span class="text-purple-400">_</span> collectionView: <span class="text-cyan-400">UICollectionView</span>, didSelectItemAt indexPath: <span class="text-cyan-400">IndexPath</span>) {
        <span class="text-pink-400">let</span> item = favorites[indexPath.item]
        presenter?.<span class="text-yellow-300">didSelectItem</span>(item)
    }
}

<span class="text-zinc-500">// MARK: - FavoriteCellDelegate</span>
<span class="text-pink-400">extension</span> <span class="text-cyan-400">FavoritesViewController</span>: <span class="text-cyan-400">FavoriteCellDelegate</span> {

    <span class="text-pink-400">func</span> <span class="text-yellow-300">favoriteCell</span>(<span class="text-purple-400">_</span> cell: <span class="text-cyan-400">FavoriteCell</span>, didTapRemove item: <span class="text-cyan-400">FavoriteItem</span>) {
        presenter?.<span class="text-yellow-300">removeItem</span>(item)
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">favoriteCell</span>(<span class="text-purple-400">_</span> cell: <span class="text-cyan-400">FavoriteCell</span>, didTapAddToCart item: <span class="text-cyan-400">FavoriteItem</span>) {
        presenter?.<span class="text-yellow-300">addToCart</span>(item)
    }
}
</pre>
                    </div>

                    <!-- FavoriteCell -->
                    <h2 class="text-2xl font-bold mt-12 mb-6">FavoriteCell</h2>

                    <div class="bg-zinc-900 rounded-xl p-6 mb-8 font-mono text-sm overflow-x-auto">
<pre class="text-zinc-300">
<span class="text-zinc-500">// FavoriteCell.swift</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">UIKit</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">SnapKit</span>
<span class="text-pink-400">import</span> <span class="text-cyan-400">Kingfisher</span>

<span class="text-pink-400">protocol</span> <span class="text-cyan-400">FavoriteCellDelegate</span>: <span class="text-cyan-400">AnyObject</span> {
    <span class="text-pink-400">func</span> <span class="text-yellow-300">favoriteCell</span>(<span class="text-purple-400">_</span> cell: <span class="text-cyan-400">FavoriteCell</span>, didTapRemove item: <span class="text-cyan-400">FavoriteItem</span>)
    <span class="text-pink-400">func</span> <span class="text-yellow-300">favoriteCell</span>(<span class="text-purple-400">_</span> cell: <span class="text-cyan-400">FavoriteCell</span>, didTapAddToCart item: <span class="text-cyan-400">FavoriteItem</span>)
}

<span class="text-pink-400">final class</span> <span class="text-cyan-400">FavoriteCell</span>: <span class="text-cyan-400">UICollectionViewCell</span> {

    <span class="text-pink-400">static let</span> reuseId = <span class="text-green-400">"FavoriteCell"</span>

    <span class="text-pink-400">weak var</span> delegate: <span class="text-cyan-400">FavoriteCellDelegate</span>?
    <span class="text-pink-400">private var</span> item: <span class="text-cyan-400">FavoriteItem</span>?

    <span class="text-pink-400">private let</span> imageView: <span class="text-cyan-400">UIImageView</span> = {
        <span class="text-pink-400">let</span> iv = <span class="text-cyan-400">UIImageView</span>()
        iv.contentMode = .scaleAspectFill
        iv.clipsToBounds = <span class="text-pink-400">true</span>
        iv.layer.cornerRadius = <span class="text-purple-400">12</span>
        iv.backgroundColor = .<span class="text-purple-400">systemGray6</span>
        <span class="text-pink-400">return</span> iv
    }()

    <span class="text-pink-400">private let</span> removeButton: <span class="text-cyan-400">UIButton</span> = {
        <span class="text-pink-400">let</span> button = <span class="text-cyan-400">UIButton</span>(type: .system)
        button.<span class="text-yellow-300">setImage</span>(<span class="text-cyan-400">UIImage</span>(systemName: <span class="text-green-400">"heart.fill"</span>), for: .normal)
        button.tintColor = .<span class="text-purple-400">systemRed</span>
        button.backgroundColor = <span class="text-cyan-400">UIColor</span>.white.<span class="text-yellow-300">withAlphaComponent</span>(<span class="text-purple-400">0.9</span>)
        button.layer.cornerRadius = <span class="text-purple-400">16</span>
        <span class="text-pink-400">return</span> button
    }()

    <span class="text-pink-400">private let</span> nameLabel: <span class="text-cyan-400">UILabel</span> = {
        <span class="text-pink-400">let</span> label = <span class="text-cyan-400">UILabel</span>()
        label.font = .<span class="text-yellow-300">systemFont</span>(ofSize: <span class="text-purple-400">14</span>, weight: .medium)
        label.numberOfLines = <span class="text-purple-400">2</span>
        <span class="text-pink-400">return</span> label
    }()

    <span class="text-pink-400">private let</span> priceLabel: <span class="text-cyan-400">UILabel</span> = {
        <span class="text-pink-400">let</span> label = <span class="text-cyan-400">UILabel</span>()
        label.font = .<span class="text-yellow-300">systemFont</span>(ofSize: <span class="text-purple-400">16</span>, weight: .bold)
        label.textColor = .<span class="text-purple-400">systemBlue</span>
        <span class="text-pink-400">return</span> label
    }()

    <span class="text-pink-400">private let</span> addToCartButton: <span class="text-cyan-400">UIButton</span> = {
        <span class="text-pink-400">let</span> button = <span class="text-cyan-400">UIButton</span>(type: .system)
        button.<span class="text-yellow-300">setImage</span>(<span class="text-cyan-400">UIImage</span>(systemName: <span class="text-green-400">"cart.badge.plus"</span>), for: .normal)
        button.tintColor = .<span class="text-purple-400">systemBlue</span>
        <span class="text-pink-400">return</span> button
    }()

    <span class="text-pink-400">override init</span>(frame: <span class="text-cyan-400">CGRect</span>) {
        <span class="text-pink-400">super</span>.<span class="text-pink-400">init</span>(frame: frame)
        <span class="text-yellow-300">setupUI</span>()
        <span class="text-yellow-300">setupActions</span>()
    }

    <span class="text-pink-400">required init?</span>(coder: <span class="text-cyan-400">NSCoder</span>) {
        <span class="text-pink-400">fatalError</span>(<span class="text-green-400">"init(coder:) has not been implemented"</span>)
    }

    <span class="text-pink-400">private func</span> <span class="text-yellow-300">setupUI</span>() {
        contentView.<span class="text-yellow-300">addSubview</span>(imageView)
        contentView.<span class="text-yellow-300">addSubview</span>(removeButton)
        contentView.<span class="text-yellow-300">addSubview</span>(nameLabel)
        contentView.<span class="text-yellow-300">addSubview</span>(priceLabel)
        contentView.<span class="text-yellow-300">addSubview</span>(addToCartButton)

        imageView.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.top.leading.trailing.equalToSuperview()
            make.height.equalTo(<span class="text-purple-400">150</span>)
        }

        removeButton.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.top.trailing.equalTo(imageView).inset(<span class="text-purple-400">8</span>)
            make.size.equalTo(<span class="text-purple-400">32</span>)
        }

        nameLabel.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.top.equalTo(imageView.snp.bottom).offset(<span class="text-purple-400">8</span>)
            make.leading.trailing.equalToSuperview().inset(<span class="text-purple-400">4</span>)
        }

        priceLabel.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.top.equalTo(nameLabel.snp.bottom).offset(<span class="text-purple-400">4</span>)
            make.leading.equalToSuperview().inset(<span class="text-purple-400">4</span>)
        }

        addToCartButton.snp.<span class="text-yellow-300">makeConstraints</span> { make <span class="text-pink-400">in</span>
            make.centerY.equalTo(priceLabel)
            make.trailing.equalToSuperview().inset(<span class="text-purple-400">4</span>)
            make.size.equalTo(<span class="text-purple-400">32</span>)
        }
    }

    <span class="text-pink-400">private func</span> <span class="text-yellow-300">setupActions</span>() {
        removeButton.<span class="text-yellow-300">addTarget</span>(<span class="text-pink-400">self</span>, action: <span class="text-pink-400">#selector</span>(removeTapped), for: .touchUpInside)
        addToCartButton.<span class="text-yellow-300">addTarget</span>(<span class="text-pink-400">self</span>, action: <span class="text-pink-400">#selector</span>(addToCartTapped), for: .touchUpInside)
    }

    <span class="text-pink-400">func</span> <span class="text-yellow-300">configure</span>(with item: <span class="text-cyan-400">FavoriteItem</span>) {
        <span class="text-pink-400">self</span>.item = item
        nameLabel.text = item.productName
        priceLabel.text = item.formattedPrice

        <span class="text-pink-400">if let</span> url = <span class="text-cyan-400">URL</span>(string: item.productImageURL) {
            imageView.kf.<span class="text-yellow-300">setImage</span>(with: url)
        }
    }

    <span class="text-pink-400">@objc private func</span> <span class="text-yellow-300">removeTapped</span>() {
        <span class="text-pink-400">guard let</span> item = item <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }
        delegate?.<span class="text-yellow-300">favoriteCell</span>(<span class="text-pink-400">self</span>, didTapRemove: item)
    }

    <span class="text-pink-400">@objc private func</span> <span class="text-yellow-300">addToCartTapped</span>() {
        <span class="text-pink-400">guard let</span> item = item <span class="text-pink-400">else</span> { <span class="text-pink-400">return</span> }
        delegate?.<span class="text-yellow-300">favoriteCell</span>(<span class="text-pink-400">self</span>, didTapAddToCart: item)
    }
}
</pre>
                    </div>

                    <!-- Summary -->
                    <div class="mt-16 p-8 bg-gradient-to-br from-primary/10 to-purple-500/10 rounded-2xl border border-primary/20">
                        <h3 class="text-xl font-bold mb-6">Что вы узнали</h3>
                        <div class="grid gap-4">
                            <div class="flex items-start gap-3">
                                <div class="w-6 h-6 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <svg class="w-3 h-3 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <p class="text-zinc-600 dark:text-zinc-400">Хранение избранного в Firestore</p>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-6 h-6 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <svg class="w-3 h-3 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <p class="text-zinc-600 dark:text-zinc-400">Toggle функциональность для добавления/удаления</p>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-6 h-6 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <svg class="w-3 h-3 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <p class="text-zinc-600 dark:text-zinc-400">Realtime обновления списка избранного</p>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-6 h-6 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <svg class="w-3 h-3 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <p class="text-zinc-600 dark:text-zinc-400">Интеграция избранного с корзиной</p>
                            </div>
                        </div>
                    </div>

                    <!-- Next Chapter Preview -->
                    <div class="mt-8 p-6 bg-zinc-100 dark:bg-zinc-800/50 rounded-2xl">
                        <h4 class="font-semibold mb-2">Следующая глава</h4>
                        <p class="text-zinc-600 dark:text-zinc-400">
                            В следующей главе мы создадим модуль заказов — научимся оформлять заказы,
                            сохранять историю и отслеживать статусы.
                        </p>
                    </div>
                </div>

                <nav class="flex justify-between gap-4 mt-16 pt-8 border-t border-zinc-200 dark:border-zinc-800">
                    <a href="17-cart.html" class="flex items-center gap-3 px-5 py-3 bg-zinc-100 dark:bg-zinc-800 hover:bg-primary hover:text-white rounded-xl transition-colors">
                        <span class="text-xl">←</span>
                        <span class="font-medium">Предыдущая</span>
                    </a>
                    <a href="19-orders.html" class="flex items-center gap-3 px-5 py-3 bg-zinc-100 dark:bg-zinc-800 hover:bg-primary hover:text-white rounded-xl transition-colors ml-auto">
                        <span class="font-medium">Следующая</span>
                        <span class="text-xl">→</span>
                    </a>
                </nav>
            </article>
        </main>
    </div>

    <script>
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        });
        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }
    </script>
</body>
</html>