<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Глава 16: Тёмная тема | Android E-Commerce</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        pre { background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .keyword { color: #569cd6; }
        .function { color: #dcdcaa; }
        .string { color: #ce9178; }
        .comment { color: #6a9955; }
        .annotation { color: #4ec9b0; }
        .number { color: #b5cea8; }
    </style>
</head>
<body class="bg-white dark:bg-zinc-900">
    <div class="max-w-4xl mx-auto px-6 py-12">
        <a href="../index.html" class="text-green-500 hover:underline mb-4 inline-block">&larr; Назад</a>
        <h1 class="text-4xl font-bold text-zinc-900 dark:text-white mb-6">Глава 16: Тёмная тема</h1>

        <div class="prose dark:prose-invert max-w-none">
            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl p-6 mb-8">
                <p class="text-green-800 dark:text-green-200 mb-0">
                    Material 3 в Compose делает реализацию тёмной темы простой. Добавим переключение
                    темы с сохранением выбора пользователя.
                </p>
            </div>

            <h2 class="text-2xl font-bold mt-8 mb-4 text-zinc-900 dark:text-white">Определение цветовых схем</h2>

            <pre><code><span class="comment">// ui/theme/Color.kt</span>
<span class="keyword">val</span> Green80 = Color(<span class="number">0xFFA8DAB5</span>)
<span class="keyword">val</span> GreenGrey80 = Color(<span class="number">0xFFB8CCB8</span>)
<span class="keyword">val</span> Pink80 = Color(<span class="number">0xFFEFB8C8</span>)

<span class="keyword">val</span> Green40 = Color(<span class="number">0xFF4CAF50</span>)
<span class="keyword">val</span> GreenGrey40 = Color(<span class="number">0xFF5D7B5D</span>)
<span class="keyword">val</span> Pink40 = Color(<span class="number">0xFF7D5260</span>)

<span class="comment">// ui/theme/Theme.kt</span>
<span class="keyword">private val</span> DarkColorScheme = darkColorScheme(
    primary = Green80,
    secondary = GreenGrey80,
    tertiary = Pink80,
    background = Color(<span class="number">0xFF121212</span>),
    surface = Color(<span class="number">0xFF1E1E1E</span>),
    onPrimary = Color.Black,
    onSecondary = Color.Black,
    onBackground = Color.White,
    onSurface = Color.White
)

<span class="keyword">private val</span> LightColorScheme = lightColorScheme(
    primary = Green40,
    secondary = GreenGrey40,
    tertiary = Pink40,
    background = Color.White,
    surface = Color(<span class="number">0xFFFFFBFE</span>),
    onPrimary = Color.White,
    onSecondary = Color.White,
    onBackground = Color(<span class="number">0xFF1C1B1F</span>),
    onSurface = Color(<span class="number">0xFF1C1B1F</span>)
)</code></pre>

            <h2 class="text-2xl font-bold mt-8 mb-4 text-zinc-900 dark:text-white">Theme Manager</h2>

            <pre><code><span class="comment">// domain/model/ThemeMode.kt</span>
<span class="keyword">enum class</span> ThemeMode {
    SYSTEM,  <span class="comment">// Следовать системе</span>
    LIGHT,   <span class="comment">// Всегда светлая</span>
    DARK     <span class="comment">// Всегда тёмная</span>
}

<span class="comment">// data/local/ThemeManager.kt</span>
<span class="keyword">interface</span> ThemeManager {
    <span class="keyword">val</span> themeMode: Flow&lt;ThemeMode&gt;
    <span class="keyword">suspend fun</span> <span class="function">setThemeMode</span>(mode: ThemeMode)
}

<span class="annotation">@Singleton</span>
<span class="keyword">class</span> ThemeManagerImpl <span class="annotation">@Inject</span> <span class="keyword">constructor</span>(
    <span class="annotation">@ApplicationContext</span> <span class="keyword">private val</span> context: Context
) : ThemeManager {

    <span class="keyword">private val</span> Context.dataStore <span class="keyword">by</span> preferencesDataStore(name = <span class="string">"settings"</span>)

    <span class="keyword">private object</span> Keys {
        <span class="keyword">val</span> THEME_MODE = stringPreferencesKey(<span class="string">"theme_mode"</span>)
    }

    <span class="keyword">override val</span> themeMode: Flow&lt;ThemeMode&gt; = context.dataStore.data
        .map { prefs ->
            <span class="keyword">val</span> value = prefs[Keys.THEME_MODE] ?: ThemeMode.SYSTEM.name
            ThemeMode.valueOf(value)
        }

    <span class="keyword">override suspend fun</span> <span class="function">setThemeMode</span>(mode: ThemeMode) {
        context.dataStore.edit { prefs ->
            prefs[Keys.THEME_MODE] = mode.name
        }
    }
}</code></pre>

            <h2 class="text-2xl font-bold mt-8 mb-4 text-zinc-900 dark:text-white">Theme Composable</h2>

            <pre><code><span class="annotation">@Composable</span>
<span class="keyword">fun</span> <span class="function">ECommerceTheme</span>(
    themeMode: ThemeMode = ThemeMode.SYSTEM,
    dynamicColor: Boolean = <span class="keyword">true</span>,
    content: <span class="annotation">@Composable</span> () -> Unit
) {
    <span class="keyword">val</span> darkTheme = <span class="keyword">when</span> (themeMode) {
        ThemeMode.SYSTEM -> isSystemInDarkTheme()
        ThemeMode.LIGHT -> <span class="keyword">false</span>
        ThemeMode.DARK -> <span class="keyword">true</span>
    }

    <span class="keyword">val</span> colorScheme = <span class="keyword">when</span> {
        <span class="comment">// Dynamic colors (Android 12+)</span>
        dynamicColor && Build.VERSION.SDK_INT >= Build.VERSION_CODES.S -> {
            <span class="keyword">val</span> context = LocalContext.current
            <span class="keyword">if</span> (darkTheme) dynamicDarkColorScheme(context)
            <span class="keyword">else</span> dynamicLightColorScheme(context)
        }
        darkTheme -> DarkColorScheme
        <span class="keyword">else</span> -> LightColorScheme
    }

    <span class="comment">// Обновление системных баров</span>
    <span class="keyword">val</span> view = LocalView.current
    <span class="keyword">if</span> (!view.isInEditMode) {
        SideEffect {
            <span class="keyword">val</span> window = (view.context <span class="keyword">as</span> Activity).window
            window.statusBarColor = colorScheme.surface.toArgb()
            WindowCompat.getInsetsController(window, view)
                .isAppearanceLightStatusBars = !darkTheme
        }
    }

    MaterialTheme(
        colorScheme = colorScheme,
        typography = Typography,
        content = content
    )
}</code></pre>

            <h2 class="text-2xl font-bold mt-8 mb-4 text-zinc-900 dark:text-white">Settings ViewModel</h2>

            <pre><code><span class="annotation">@HiltViewModel</span>
<span class="keyword">class</span> SettingsViewModel <span class="annotation">@Inject</span> <span class="keyword">constructor</span>(
    <span class="keyword">private val</span> themeManager: ThemeManager
) : ViewModel() {

    <span class="keyword">val</span> themeMode = themeManager.themeMode
        .stateIn(viewModelScope, SharingStarted.WhileSubscribed(<span class="number">5000</span>), ThemeMode.SYSTEM)

    <span class="keyword">fun</span> <span class="function">setThemeMode</span>(mode: ThemeMode) {
        viewModelScope.launch {
            themeManager.setThemeMode(mode)
        }
    }
}</code></pre>

            <h2 class="text-2xl font-bold mt-8 mb-4 text-zinc-900 dark:text-white">Settings Screen</h2>

            <pre><code><span class="annotation">@Composable</span>
<span class="keyword">fun</span> <span class="function">SettingsScreen</span>(
    viewModel: SettingsViewModel = hiltViewModel(),
    onNavigateBack: () -> Unit
) {
    <span class="keyword">val</span> themeMode <span class="keyword">by</span> viewModel.themeMode.collectAsStateWithLifecycle()

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text(<span class="string">"Настройки"</span>) },
                navigationIcon = {
                    IconButton(onClick = onNavigateBack) {
                        Icon(Icons.AutoMirrored.Filled.ArrowBack, <span class="keyword">null</span>)
                    }
                }
            )
        }
    ) { padding ->
        Column(modifier = Modifier.padding(padding)) {
            Text(
                text = <span class="string">"Оформление"</span>,
                style = MaterialTheme.typography.titleSmall,
                color = MaterialTheme.colorScheme.primary,
                modifier = Modifier.padding(<span class="number">16</span>.dp)
            )

            ThemeOption.entries.forEach { option ->
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .clickable { viewModel.setThemeMode(option.mode) }
                        .padding(<span class="number">16</span>.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(option.icon, <span class="keyword">null</span>)
                    Text(
                        text = option.title,
                        modifier = Modifier.weight(<span class="number">1</span>f).padding(start = <span class="number">16</span>.dp)
                    )
                    RadioButton(
                        selected = themeMode == option.mode,
                        onClick = { viewModel.setThemeMode(option.mode) }
                    )
                }
            }
        }
    }
}

<span class="keyword">enum class</span> ThemeOption(
    <span class="keyword">val</span> mode: ThemeMode,
    <span class="keyword">val</span> title: String,
    <span class="keyword">val</span> icon: ImageVector
) {
    SYSTEM(ThemeMode.SYSTEM, <span class="string">"Как в системе"</span>, Icons.Default.Brightness6),
    LIGHT(ThemeMode.LIGHT, <span class="string">"Светлая"</span>, Icons.Default.LightMode),
    DARK(ThemeMode.DARK, <span class="string">"Тёмная"</span>, Icons.Default.DarkMode)
}</code></pre>

            <h2 class="text-2xl font-bold mt-8 mb-4 text-zinc-900 dark:text-white">Использование в MainActivity</h2>

            <pre><code><span class="annotation">@AndroidEntryPoint</span>
<span class="keyword">class</span> MainActivity : ComponentActivity() {

    <span class="keyword">private val</span> settingsViewModel: SettingsViewModel <span class="keyword">by</span> viewModels()

    <span class="keyword">override fun</span> <span class="function">onCreate</span>(savedInstanceState: Bundle?) {
        <span class="keyword">super</span>.onCreate(savedInstanceState)
        enableEdgeToEdge()

        setContent {
            <span class="keyword">val</span> themeMode <span class="keyword">by</span> settingsViewModel.themeMode.collectAsStateWithLifecycle()

            ECommerceTheme(themeMode = themeMode) {
                AppNavigation()
            }
        }
    }
}</code></pre>

            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl p-6 mt-8">
                <h3 class="font-semibold text-green-900 dark:text-green-100 mb-3">Что мы изучили</h3>
                <ul class="text-green-800 dark:text-green-200 space-y-2">
                    <li>• <strong>Material 3 Color Schemes</strong> — светлая и тёмная палитра</li>
                    <li>• <strong>Dynamic Colors</strong> — цвета из обоев (Android 12+)</li>
                    <li>• <strong>ThemeManager</strong> — сохранение выбора в DataStore</li>
                    <li>• <strong>System Bars</strong> — адаптация статус бара под тему</li>
                </ul>
            </div>
        </div>

        <div class="flex justify-between items-center mt-12 pt-8 border-t border-zinc-200 dark:border-zinc-800">
            <a href="15-profile.html" class="text-green-500 hover:underline">&larr; Профиль</a>
            <a href="../index.html" class="text-green-500 hover:underline">Оглавление</a>
            <a href="17-animations.html" class="text-green-500 hover:underline">Анимации &rarr;</a>
        </div>
    </div>
</body>
</html>
